---
import { getCollection, getEntry } from 'astro:content';
import slugify, { slugifyStr } from '@/utils/slugify';
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Datetime from '@/components/Datetime.astro';
import Footer from '@/components/Footer.astro';
import Tag from '@/components/Tag.astro';
import { SITE } from '@/config';
import PostToc from '@/components/PostToc.astro';
import MdArticle from '@/components/MdArticle.astro';

export async function getStaticPaths() {
  const allBlogPosts = await getCollection('blog', ({ data }) => !data.draft);
  return allBlogPosts.map((post) => ({ params: { slug: slugify(post.data) } }));
}

const { slug } = Astro.params;

const post = await getEntry('blog', slug);
if (!post) return Astro.redirect('/404');

const { Content, headings } = await post.render();

const { title, author, description, ogImage, pubDatetime, labels, canonicalURL } = post.data;

const ogImageUrl = typeof ogImage === 'string' ? ogImage : ogImage?.src;
const ogUrl = new URL(ogImageUrl ?? `${SITE.base}posts/${slugifyStr(title)}.png`, Astro.url.origin).href;
---

<Layout title={title} author={author} description={description} ogImage={ogUrl} canonicalURL={canonicalURL}>
  <Header />

  <div class="mx-auto max-w-3xl w-full flex justify-start px-2">
    <button class="mb-2 mt-4 flex hover:op-75" onclick="history.back()">
      <i class="i-custom-back text-2xl"></i>
      <span>返回</span>
    </button>
  </div>

  <main class="mx-auto max-w-3xl w-full px-4 pb-12">
    <h1 transition:name={encodeURIComponent(slugifyStr(title))} class="text-2xl font-semibold c-accent">{title}</h1>

    <Datetime datetime={pubDatetime} size="lg" className="my-2" />

    <div class="relative mx-auto mt-8 max-w-3xl">
      <MdArticle>
        <Content />
      </MdArticle>
      {headings.length > 0 && <PostToc data={headings} />}
    </div>

    <ul class="my-8">
      {labels.map((tag) => <Tag name={slugifyStr(tag)} />)}
    </ul>
  </main>

  <Footer />
</Layout>
