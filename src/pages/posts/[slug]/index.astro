---
import { getCollection, getEntry } from 'astro:content';

import Footer from '@/components/Footer.astro';
import Header from '@/components/Header.astro';
import MdArticle from '@/components/MdArticle.astro';
import PostToc from '@/components/PostToc.astro';
import SubTitle from '@/components/SubTitle.astro';
import Tag from '@/components/Tag.astro';
import Layout from '@/layouts/Layout.astro';
import Main from '@/layouts/Main.astro';
import { slugify, slugifyStr,unicodeSlugify } from '@/utils/slugify';

export async function getStaticPaths() {
  const allBlogPosts = await getCollection('blog', ({ data }) => !data.draft);
  return allBlogPosts.map((post) => ({ params: { slug: slugify(post.data) } }));
}

const { slug } = Astro.params;

const post = await getEntry('blog', slug);
if (!post) return Astro.redirect('/404');

const { Content, headings } = await post.render();

const { title, description, ogImage, pubDatetime, tags, canonicalURL } = post.data;

const ogImageUrl = typeof ogImage === 'string' ? ogImage : ogImage?.src;
const ogUrl = new URL(ogImageUrl ?? `/posts/${slugifyStr(title)}.png`, Astro.url.origin).href;
---

<Layout title={title} description={description} ogImage={ogUrl} canonicalURL={canonicalURL}>
  <Header />

  <Main>
    <div class="mb-2 w-full flex justify-start">
      <button class="flex hover:op-75" onclick="history.back()">
        <i class="i-custom-back text-2xl"></i>
        <span>返回</span>
      </button>
    </div>

    <h1 transition:name={unicodeSlugify(title)} class="text-2xl font-semibold c-accent">{title}</h1>

    <SubTitle datetime={pubDatetime} size="lg" className="my-2" title={title} />

    <div class="relative mx-auto mt-8 max-w-3xl">
      <MdArticle>
        <Content />
      </MdArticle>
      {headings.length > 0 && <PostToc data={headings} />}
    </div>

    <ul class="mt-8">
      {tags.map((tag) => <Tag name={slugifyStr(tag)} />)}
    </ul>
  </Main>

  <Footer />
</Layout>
